{% extends "base.html" %}

{% block content %}
    <table class="table table-striped">
        <thead class="thead-dark">
        <tr><th scope="col">Name</th><th scope="col">Display Name</th><th scope="col">Retrieve</th></tr>
        </thead>
        {% for secret in secrets %}
        <tr>
            <td scope="row">{{secret.id}}</td>
            <td>{{secret.display_name}}</td>
            <!--<td><a href="{{ url_for('view_secret', key=secret.key)}}">Click</a> </td>-->
            <td>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#tokenModal" data-url="{{url_for('view_secret', key=secret.key)}}">View Token</button>
            </td>
        </tr>
        {% endfor %}
    </table>

    <!-- Modal -->
    <div class="modal fade" id="tokenModal" tabindex="-1" role="dialog" aria-labelledby="tokenModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="tokenModal">Token Code</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Token Code: <span id="token-code">Loading</span>
              <br>
              Time Remaining: <span id="token-time">0</span>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      <script>
          var time_remaining = 0;
          var current_url = null;
          var modal = null;

          setInterval(function(){
              if(time_remaining <= 0 && current_url){
                $.get(current_url, function(data, status){
                  modal.find('#token-code').text(data.token)
                  time_remaining = data.time_remaining
                })}else if (current_url){
                  time_remaining = time_remaining - 1
                }
                if(modal){
                  modal.find('#token-time').text(time_remaining)
                }
            }, 1000);
            document.addEventListener("DOMContentLoaded", function(event) { 
                $('#tokenModal').on('show.bs.modal', function (event) {
                    var button = $(event.relatedTarget); // Button that triggered the modal
                    current_url = button.data('url'); // Extract info from data-* attributes
                    modal = $(this);
                })

                $(document).on('hidden.bs.modal', function (e) {
                  current_url = null;
                  modal = null;
                  time_remaining = 0;
                });
            });
      </script>
{% endblock %}